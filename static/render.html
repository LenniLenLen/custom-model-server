<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Render Preview</title>
<style>
  html,body { margin:0; padding:0; background:transparent; }
  #container { width:512px; height:512px; }
</style>
</head>
<body>
<div id="container"></div>

<script src="https://unpkg.com/three@0.162.0/build/three.min.js"></script>
<script src="https://unpkg.com/prismarine-viewer@latest/dist/prismarine-viewer.min.js"></script>

<script>
(async () => {
  const pathParts = location.pathname.split('/');
  const modelName = decodeURIComponent(pathParts[pathParts.length - 1] || '');
  if (!modelName) { console.error('No modelName'); return; }

  const container = document.getElementById('container');
  const viewer = PrismarineViewer.createViewer(container, { width: 512, height: 512, zoom: 2.5, background: 0x00000000 });

  const three = viewer.THREE;
  const scene = viewer.scene;

  async function findFile(exts) {
    const res = await fetch(`/model-file/${encodeURIComponent(modelName)}/`);
    if (!res.ok) return null;
    const files = await res.json().catch(()=>[]);
    for (const f of files) {
      for (const e of exts) if (f.toLowerCase().endsWith(e)) return f;
    }
    return null;
  }

  // Find 3D model (any supported extension)
  let modelFile = await findFile(['.json','.obj','.gltf','.glb','.fbx']);
  let textureFile = await findFile(['.png']);
  
  if (!modelFile) {
    // fallback: gray cube
    const cube = new three.Mesh(new three.BoxGeometry(1,1,1), new three.MeshNormalMaterial());
    scene.add(cube);
    viewer.camera.position.set(1.2,1.2,2.5);
    viewer.camera.lookAt(0,0,0);
    window.__THUMB_READY = true;
    return;
  }

  // Load model using PrismarineViewer
  let modelUrl = `/model-file/${encodeURIComponent(modelName)}/${modelFile}`;
  let loader = new PrismarineViewer.OBJLoader(); // fallback, depends on format
  try {
    const obj = await loader.load(modelUrl);
    if (textureFile) {
      const tex = await new Promise(resolve => new three.TextureLoader().load(`/model-file/${encodeURIComponent(modelName)}/${textureFile}`, resolve, undefined, ()=>resolve(null)));
      obj.traverse(child => { if (child.isMesh) child.material.map = tex; });
    }
    scene.add(obj);
    viewer.camera.position.set(1.2,1.2,2.5);
    viewer.camera.lookAt(0,0,0);
  } catch (e) {
    console.error('Model load failed', e);
    const cube = new three.Mesh(new three.BoxGeometry(1,1,1), new three.MeshNormalMaterial());
    scene.add(cube);
  }

  window.__THUMB_READY = true;
})();
</script>
</body>
</html>
